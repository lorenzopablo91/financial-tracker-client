<div class="dashboard-container">
  <!-- Header superior -->
  <div class="dashboard-header">
    <!-- Selector de Portafolios (Izquierda) -->
    <div class="portfolio-selector">
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Portafolio</mat-label>
        <mat-select [value]="selectedPortfolioId()" (selectionChange)="onPortfolioChange($event.value)"
          [disabled]="isLoadingPortfolios() || loading()">
          @if (isLoadingPortfolios()) {
          <mat-option disabled>
            <div class="loading-option">
              <mat-spinner diameter="20"></mat-spinner>
              <span>Cargando portafolios...</span>
            </div>
          </mat-option>
          } @else if (portfolios().length === 0) {
          <mat-option disabled>
            <span>No hay portafolios disponibles</span>
          </mat-option>
          } @else {
          @for (portfolio of portfolios(); track portfolio.id) {
          <mat-option [value]="portfolio.id">
            {{ portfolio.nombre }}
          </mat-option>
          }
          }
        </mat-select>
      </mat-form-field>
    </div>

    <!-- DescripciÃ³n del Portafolio (Centro) -->
    <div class="portfolio-description">
      @if (hasSelectedPortfolio()) {
      <mat-icon>wallet</mat-icon>
      <span>{{ portfolioDescription() }}</span>
      } @else {
      <mat-icon class="no-portfolio">info_outline</mat-icon>
      <span class="no-portfolio-text">Debe seleccionar un portafolio para visualizar los datos</span>
      }
    </div>

    <!-- Controles del Dashboard (Derecha) -->
    <div class="dashboard-controls">
      <button mat-icon-button (click)="toggleAmountVisibility()"
        [matTooltip]="hideAmounts() ? 'Mostrar montos' : 'Ocultar montos'" class="visibility-btn"
        [disabled]="loading() || !hasSelectedPortfolio()">
        <mat-icon>{{ hideAmounts() ? 'visibility' : 'visibility_off' }}</mat-icon>
      </button>

      <div class="refresh-section">
        @if (lastUpdated()) {
        <span class="text-muted">
          Ãšltima actualizaciÃ³n: {{ lastUpdated() | date:'M/d/yy, h:mm a' }}
        </span>
        }
        <button mat-icon-button (click)="refreshData()" matTooltip="Actualizar datos"
          [disabled]="loading() || !hasSelectedPortfolio()">
          <mat-icon [class.spinning]="loading()">refresh</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Contenido del Dashboard -->
  @if (!hasSelectedPortfolio()) {
  <!-- Mensaje cuando no hay portafolio seleccionado -->
  <div class="no-portfolio-message">
    <mat-icon>wallet</mat-icon>
    <h2>No hay portafolio seleccionado</h2>
    <p>Por favor, seleccione un portafolio del menÃº superior para visualizar sus datos.</p>
  </div>
  } @else {
  <!-- Dashboard con datos -->
  <div class="dashboard-layout" [class.has-investments]="!hasCashOnly()">
    <!-- Columna izquierda - GrÃ¡fico evoluciÃ³n + Billetera/Torta -->
    <div class="wallet-section">
      <!-- GrÃ¡fico de evoluciÃ³n - PRIMERA COLUMNA -->
      <app-wallet-evolution-chart [chartData]="walletHistoryData()" [hideAmounts]="hideAmounts()"
        [isLoading]="loading()" [refreshTrigger]="refreshTrigger()" class="evolution-chart">
      </app-wallet-evolution-chart>

      <!-- Total de billetera + GrÃ¡fico categorÃ­as - SEGUNDA COLUMNA -->
      <mat-card class="total-card">
        @if (loading()) {
        <!-- Estado de carga -->
        <div class="skeleton-content">
          <div class="skeleton-title"></div>
          <div class="skeleton-amount"></div>
          <div class="skeleton-chart"></div>
        </div>
        } @else if (error()) {
        <!-- Estado de error -->
        <div class="error-content">
          <mat-icon class="error-icon-small">error_outline</mat-icon>
          <span>{{ error() }}</span>
        </div>
        } @else {
        <!-- Contenido normal -->
        <div class="summary-content">
          <!-- TÃ­tulo de la card arriba del monto -->
          <div class="card-title">
            <span class="summary-title">ðŸ’° TOTAL PORTAFOLIO</span>
          </div>

          <!-- Total Amount centrado -->
          <div class="total-amount-container">
            <div class="total-amount" [class.hidden-amount]="hideAmounts()">
              {{ hideAmounts() ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : (totalWallet() | currencyFormat:'USD') }}
            </div>
          </div>

          <!-- GrÃ¡fico de categorÃ­as centrado -->
          <div class="categories-chart-section">
            <app-wallet-categories-chart [categories]="categories()" [totalAmount]="totalWallet()"
              [hideAmounts]="hideAmounts()">
            </app-wallet-categories-chart>
          </div>
        </div>
        }
      </mat-card>
    </div>

    <!-- Columna derecha - Cards de rendimiento (solo si hay inversiones) -->
    @if (!hasCashOnly()) {
    <div class="performance-section">
      <div class="performance-cards">
        @for (category of performanceCardsData(); track $index) {
        <app-wallet-performance-card [data]="category" [hideAmounts]="hideAmounts()" [isLoading]="loading()"
          [hasError]="!!error()">
        </app-wallet-performance-card>
        }
      </div>
    </div>
    }
  </div>
  }
</div>