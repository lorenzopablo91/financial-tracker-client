<div class="dashboard-container">
  <!-- Header superior -->
  <div class="dashboard-header">
    <!-- Selector de Portafolios (Izquierda) -->
    <div class="portfolio-selector">
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Portafolio</mat-label>
        <mat-select [value]="selectedPortfolioId()" (selectionChange)="onPortfolioChange($event.value)"
          [disabled]="isLoadingPortfolios() || loading()">
          @if (isLoadingPortfolios()) {
          <mat-option disabled>
            <div class="loading-option">
              <mat-spinner diameter="20"></mat-spinner>
              <span>Cargando portafolios...</span>
            </div>
          </mat-option>
          } @else if (portfolios().length === 0) {
          <mat-option disabled>
            <span>No hay portafolios disponibles</span>
          </mat-option>
          } @else {
          @for (portfolio of portfolios(); track portfolio.id) {
          <mat-option [value]="portfolio.id">
            {{ portfolio.nombre }}
          </mat-option>
          }
          }
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Controles del Dashboard (Derecha) -->
    <div class="dashboard-controls">
      <div class="refresh-section">
        @if (lastUpdated()) {
        <span class="text-muted">
          Ãšltima actualizaciÃ³n: {{ lastUpdated() | date:'M/d/yy, h:mm a' }}
        </span>
        }
        <button mat-icon-button (click)="refreshData()" matTooltip="Actualizar datos"
          [disabled]="loading() || !hasSelectedPortfolio()">
          <mat-icon [class.spinning]="loading()">refresh</mat-icon>
        </button>
      </div>
      <button mat-icon-button (click)="toggleAmountVisibility()"
        [matTooltip]="hideAmounts() ? 'Mostrar montos' : 'Ocultar montos'" class="visibility-btn"
        [disabled]="loading() || !hasSelectedPortfolio()">
        <mat-icon>{{ hideAmounts() ? 'visibility' : 'visibility_off' }}</mat-icon>
      </button>

      <!-- MenÃº Hamburguesa -->
      <button mat-icon-button [matMenuTriggerFor]="dashboardMenu" matTooltip="MÃ¡s opciones" class="menu-btn"
        [disabled]="loading()">
        <mat-icon>menu</mat-icon>
      </button>
      <mat-menu #dashboardMenu="matMenu">
        <button mat-menu-item (click)="onDepositMoney()" [disabled]="!hasSelectedPortfolio()">
          <mat-icon>account_balance_wallet</mat-icon>
          <span>Ingresar dinero</span>
        </button>
        <button mat-menu-item (click)="onBuyAsset()" [disabled]="!hasSelectedPortfolio()">
          <mat-icon>shopping_cart</mat-icon>
          <span>Comprar activo</span>
        </button>
        <button mat-menu-item (click)="onSellAsset()" [disabled]="!hasSelectedPortfolio()">
          <mat-icon>sell</mat-icon>
          <span>Vender activo</span>
        </button>
        <button mat-menu-item (click)="onWithdrawMoney()" [disabled]="!hasSelectedPortfolio()">
          <mat-icon>money_off</mat-icon>
          <span>Retirar dinero</span>
        </button>
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="onViewTransactions()" [disabled]="!hasSelectedPortfolio()">
          <mat-icon>receipt_long</mat-icon>
          <span>Detalle de operaciones</span>
        </button>
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="onNewPortfolio()">
          <mat-icon>add</mat-icon>
          <span>Nuevo portafolio</span>
        </button>
      </mat-menu>
    </div>
  </div>

  <!-- DescripciÃ³n del Portafolio (debajo en mobile, oculta en desktop) -->
  <div class="portfolio-description">
    @if (hasSelectedPortfolio()) {
    <mat-icon>wallet</mat-icon>
    <span>{{ portfolioDescription() }}</span>
    } @else {
    <mat-icon class="no-portfolio">info_outline</mat-icon>
    <span class="no-portfolio-text">Debe seleccionar un portafolio para visualizar los datos</span>
    }
  </div>

  <!-- Contenido del Dashboard -->
  @if (!hasSelectedPortfolio()) {
  <!-- Mensaje cuando no hay portafolio seleccionado -->
  <div class="no-portfolio-message">
    <mat-icon>wallet</mat-icon>
    <h2>No hay portafolio seleccionado</h2>
    <p>Por favor, seleccione un portafolio del menÃº superior para visualizar sus datos.</p>
  </div>
  } @else {
  <!-- Dashboard con datos -->
  <div class="dashboard-layout">

    <!-- Carrusel de Cards de Rendimiento (solo si hay inversiones) -->
    @if (!hasCashOnly()) {
    <div class="performance-carousel-section">
      @if (loading()) {
      <!-- Skeleton para las cards de rendimiento -->
      <div class="performance-carousel">
        @for (item of [1, 2, 3, 4]; track $index) {
        <div class="performance-card-skeleton">
          <div class="skeleton-header">
            <div class="skeleton-icon"></div>
            <div class="skeleton-title"></div>
          </div>
          <div class="skeleton-amount"></div>
          <div class="skeleton-percentage"></div>
        </div>
        }
      </div>
      } @else {
      <!-- Cards reales -->
      <div class="performance-carousel">
        @for (category of performanceCardsData(); track $index) {
        <app-wallet-performance-card [data]="category" [hideAmounts]="hideAmounts()" [isLoading]="loading()"
          [hasError]="!!error()">
        </app-wallet-performance-card>
        }
      </div>
      }
    </div>
    }

    <!-- SecciÃ³n de grÃ¡ficos principales -->
    <div class="charts-section">
      <!-- Card Total + GrÃ¡fico de Torta (Izquierda) -->
      <mat-card class="total-card">
        @if (loading()) {
        <!-- Estado de carga -->
        <div class="skeleton-content">
          <div class="skeleton-title"></div>
          <div class="skeleton-amount"></div>
          <div class="skeleton-chart"></div>
        </div>
        } @else if (error()) {
        <!-- Estado de error -->
        <div class="error-content">
          <mat-icon class="error-icon-small">error_outline</mat-icon>
          <span>{{ error() }}</span>
        </div>
        } @else {
        <!-- Contenido normal -->
        <div class="summary-content">
          <!-- TÃ­tulo de la card arriba del monto -->
          <div class="card-title">
            <span class="summary-title">ðŸ’° TOTAL PORTAFOLIO</span>
          </div>

          <!-- Total Amount centrado -->
          <div class="total-amount-container">
            <div class="total-amount" [class.hidden-amount]="hideAmounts()">
              {{ hideAmounts() ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : (totalWallet() | currencyFormat:'USD') }}
            </div>
          </div>

          <!-- GrÃ¡fico de categorÃ­as centrado -->
          <div class="categories-chart-section">
            <app-wallet-categories-chart [categories]="categories()" [totalAmount]="totalWallet()"
              [hideAmounts]="hideAmounts()">
            </app-wallet-categories-chart>
          </div>
        </div>
        }
      </mat-card>

      <!-- GrÃ¡fico de EvoluciÃ³n (Derecha) -->
      <app-wallet-evolution-chart [chartData]="walletHistoryData()" [hideAmounts]="hideAmounts()"
        [isLoading]="loading()" [refreshTrigger]="refreshTrigger()" class="evolution-chart">
      </app-wallet-evolution-chart>
    </div>
  </div>
  }
</div>