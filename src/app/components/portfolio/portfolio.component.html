<div class="portfolio-container">
  <!-- Header superior -->
  <div class="portfolio-header">
    <!-- Selector de Portafolios (Izquierda) -->
    <div class="portfolio-selector">
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Portafolio</mat-label>
        <mat-select [value]="selectedPortfolioId()" (selectionChange)="onPortfolioChange($event.value)"
          [disabled]="isLoadingPortfolios() || isLoadingPortfolios()">
          @if (isLoadingPortfolios()) {
          <mat-option disabled>
            <div class="loading-option">
              <mat-spinner diameter="20"></mat-spinner>
              <span>Cargando portafolios...</span>
            </div>
          </mat-option>
          } @else if (portfolios().length === 0) {
          <mat-option disabled>
            <span>No hay portafolios disponibles</span>
          </mat-option>
          } @else {
          @for (portfolio of portfolios(); track portfolio.id) {
          <mat-option [value]="portfolio.id">
            {{ portfolio.nombre }}
          </mat-option>
          }
          }
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Controles del Portfolio (Derecha) -->
    <div class="portfolio-controls">
      <div class="refresh-section">
        @if (lastUpdated()) {
        <span class="text-muted">
          √öltima actualizaci√≥n: {{ lastUpdated() | date:'M/d/yy, h:mm a' }}
        </span>
        }
        <button mat-icon-button (click)="refreshData()" matTooltip="Actualizar datos"
          [disabled]="isLoadingPortfolios() || !hasSelectedPortfolio() || showTransactions()">
          <mat-icon [class.spinning]="isLoadingPortfolios()">refresh</mat-icon>
        </button>
      </div>
      <button mat-icon-button (click)="toggleAmountVisibility()"
        [matTooltip]="hideAmounts() ? 'Mostrar montos' : 'Ocultar montos'" class="visibility-btn"
        [disabled]="isLoadingPortfolios() || !hasSelectedPortfolio()">
        <mat-icon>{{ hideAmounts() ? 'visibility' : 'visibility_off' }}</mat-icon>
      </button>

      <!-- Men√∫ Hamburguesa -->
      <button mat-icon-button [matMenuTriggerFor]="portfolioMenu" matTooltip="M√°s opciones" class="menu-btn"
        [disabled]="isLoadingPortfolios()">
        <mat-icon>menu</mat-icon>
      </button>
      <mat-menu #portfolioMenu="matMenu">
        <button mat-menu-item (click)="onNewPortfolio()" [disabled]="!isAdmin()">
          <mat-icon>add</mat-icon>
          <span>Crear portafolio</span>
        </button>
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="onViewAssetsDetail()" [disabled]="!hasSelectedPortfolio()">
          <mat-icon>list_alt</mat-icon>
          <span>Detalle de activos</span>
        </button>
        <button mat-menu-item (click)="onViewTransactions()" [disabled]="!hasSelectedPortfolio()">
          <mat-icon>receipt_long</mat-icon>
          <span>Detalle de operaciones</span>
        </button>
        <button mat-menu-item (click)="onCreateSnapshot()" [disabled]="!hasSelectedPortfolio() || !isAdmin()">
          <mat-icon>save</mat-icon>
          <span>Guardar valuaci√≥n</span>
        </button>
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="onDeletePortfolio()" [disabled]="!hasSelectedPortfolio() || !isAdmin()">
          <mat-icon>delete</mat-icon>
          <span>Eliminar portafolio</span>
        </button>
      </mat-menu>
    </div>
  </div>

  <!-- Descripci√≥n del Portafolio (debajo en mobile, oculta en desktop) -->
  <div class="portfolio-description">
    @if (hasSelectedPortfolio()) {
    <mat-icon>wallet</mat-icon>
    <span>{{ portfolioDescription() }}</span>
    } @else {
    <mat-icon class="no-portfolio">info_outline</mat-icon>
    <span class="no-portfolio-text">Debe seleccionar un portafolio para visualizar los datos</span>
    }
  </div>

  <!-- Contenido del Portfolio -->
  @if (!hasSelectedPortfolio()) {
  <!-- Mensaje cuando no hay portafolio seleccionado -->
  <div class="no-portfolio-message">
    <mat-icon>wallet</mat-icon>
    <h2>No hay portafolio seleccionado</h2>
    <p>Por favor, seleccione un portafolio del men√∫ superior para visualizar sus datos.</p>
  </div>
  } @else {

  @if (showTransactions()) {
  <!-- Vista de Transacciones -->
  <app-portfolio-transactions 
    [transactions]="transactions()" 
    [hideAmounts]="hideAmounts()"
    [isLoading]="isLoadingTransactions()"
    [portfolioAssets]="convertActivosToPortfolioAssets()"
    [portfolioId]="selectedPortfolioId()!"
    (backClicked)="onBackToPortfolio()"
    (transactionCompleted)="onTransactionCompleted()">
  </app-portfolio-transactions>
  } @else if (showAssetsDetail()) {
  <!-- Vista de Detalle de Activos -->
  <app-portfolio-assets-detail 
    [assets]="assets()" 
    [hideAmounts]="hideAmounts()" 
    [isLoading]="isLoadingPortfolios()"
    [initialCategoryFilter]="selectedCategoryType()" 
    (backClicked)="onBackToPortfolio()">
  </app-portfolio-assets-detail>
  } @else {
  <!-- Portfolio con datos -->
  <div class="portfolio-layout">

    <!-- Carrusel de Cards de Rendimiento (solo si hay inversiones) -->
    @if (!hasCashOnly()) {
    <div class="performance-carousel-section">
      @if (isLoadingPortfolios()) {
      <!-- Skeleton para las cards de rendimiento -->
      <div class="performance-carousel">
        @for (item of [1, 2, 3, 4]; track $index) {
        <div class="performance-card-skeleton">
          <div class="skeleton-header">
            <div class="skeleton-icon"></div>
            <div class="skeleton-title"></div>
          </div>
          <div class="skeleton-amount"></div>
          <div class="skeleton-percentage"></div>
        </div>
        }
      </div>
      } @else {
      <!-- Cards reales -->
      <div class="performance-carousel">
        @for (category of performanceCardsData(); track $index) {
        <app-portfolio-performance-card 
          [data]="category" 
          [hideAmounts]="hideAmounts()"
          [isLoading]="isLoadingPortfolios()" 
          (cardClicked)="onCategorySelected($event)">
        </app-portfolio-performance-card>
        }
      </div>
      }
    </div>
    }

    <!-- Secci√≥n de gr√°ficos principales -->
    <div class="charts-section">
      <!-- Card Total + Gr√°fico de Torta (Izquierda) -->
      <mat-card class="total-card">
        @if (isLoadingPortfolios()) {
        <!-- Estado de carga -->
        <div class="skeleton-content">
          <div class="skeleton-title"></div>
          <div class="skeleton-amount"></div>
          <div class="skeleton-chart"></div>
        </div>
        } @else {
        <!-- Contenido normal -->
        <div class="summary-content">
          <!-- T√≠tulo de la card arriba del monto -->
          <div class="card-title">
            <span class="summary-title">üí∞ TOTAL PORTAFOLIO</span>
          </div>

          <!-- Total Amount centrado -->
          <div class="total-amount-container">
            <div class="total-amount" [class.hidden-amount]="hideAmounts()">
              {{ hideAmounts() ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : (totalPortfolio() | currencyFormat:'USD') }}
            </div>
          </div>

          <!-- Gr√°fico de categor√≠as centrado -->
          <div class="categories-chart-section">
            <app-portfolio-categories-chart 
              [categories]="categories()" 
              [totalAmount]="totalPortfolio()"
              [hideAmounts]="hideAmounts()" 
              (categoryClicked)="onCategorySelected($event)">
            </app-portfolio-categories-chart>
          </div>
        </div>
        }
      </mat-card>

      <!-- Gr√°fico de Evoluci√≥n (Derecha) -->
      <app-portfolio-evolution-chart 
        [chartData]="portfolioHistoryData()" 
        [hideAmounts]="hideAmounts()"
        [isLoading]="isLoadingPortfolios()" 
        [refreshTrigger]="refreshTrigger()" 
        class="evolution-chart">
      </app-portfolio-evolution-chart>
    </div>
  </div>
  }
  }
</div>